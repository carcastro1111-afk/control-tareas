<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Tareas Ariba (Online)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root{--bg-color:#1a1a2e;--primary-color:#16213e;--secondary-color:#0f3460;--accent-color:#e94560;--font-color:#e0e0e0;--card-bg:#1f2847;--completed-color:#2ecc71;--pending-color:#f1c40f;--urgent-color:#e74c3c;--border-color:#3a4a78}html,body{height:100%;margin:0;padding:0;overflow:hidden}body{font-family:'Poppins',sans-serif;background-color:var(--bg-color);color:var(--font-color);padding:20px;box-sizing:border-box}.container{max-width:1600px;margin:auto;height:calc(100% - 70px)}header{text-align:center;margin-bottom:20px;color:var(--accent-color);height:50px}
        
        #calendar-container{
            background-color:var(--primary-color);
            padding: 25px; 
            border-radius:15px;
            box-shadow:0 4px 20px rgba(0,0,0,.4);
            height:100%; 
            box-sizing:border-box; 
            overflow-y: auto; /* El contenedor principal maneja el scroll */
            position: relative;
        }
         #calendar, .fc .fc-view-harness, .fc .fc-scroller {
             height: auto !important; 
             overflow: visible !important; 
             padding-right: 0 !important;
             box-sizing: border-box !important;
         }
         .fc table, .fc .fc-col-header {
             width: 100% !important;
             table-layout: fixed; 
             padding-right: 0 !important;
             box-sizing: border-box !important;
         }
        .fc .fc-daygrid-day-frame { position: relative; min-height: 100px; padding-top: 20px; box-sizing: border-box; }
        .fc .fc-daygrid-day-number { position: absolute; top: 4px; left: 6px; padding: 0; float: none; text-align: left; z-index: 1; }
        .fc .fc-daygrid-day-events { position: relative; z-index: 0; margin-top: 0; }

        .fc{font-size:1em;--fc-border-color:var(--border-color);--fc-today-bg-color:rgba(233,69,69,.15);--fc-event-text-color:#fff}.fc .fc-toolbar-title{color:var(--font-color)}.fc .fc-button-primary{background-color:var(--secondary-color);border-color:var(--secondary-color)}.fc .fc-button-primary:hover,.fc .fc-button-active{background-color:var(--accent-color)!important;border-color:var(--accent-color)!important}.fc .fc-daygrid-day.fc-day-today .fc-daygrid-day-number{color:var(--accent-color);font-weight:700}.fc-event{border-width:2px!important;cursor:pointer;transition:transform .2s ease,filter .2s ease}.fc-event:hover{transform:scale(1.05);filter:brightness(1.2);z-index:10}.fc-event-main-frame{white-space:normal!important}.fc-event-title-container{padding:1px 3px}.fc-event-title{font-size:.8em}.fc-event.status-pending{background-color:var(--pending-color)!important;border-color:var(--pending-color)!important;color:#000!important}.fc-event.status-urgent{background-color:var(--urgent-color)!important;border-color:var(--urgent-color)!important}.fc-event.status-completed{background-color:var(--completed-color)!important;border-color:var(--completed-color)!important;text-decoration:line-through}.fc-list{border:none!important}.fc-list-event:hover td{background-color:var(--secondary-color)!important}.fc-list-event-title a{color:var(--font-color)!important}.fc-list-day-cushion{background-color:var(--card-bg)!important;color:var(--accent-color)!important;padding:10px 15px!important}.fc-list-table tbody tr,.fc-list-table thead tr{background-color:transparent!important}.fc-list-event.status-pending .fc-list-event-dot{border-color:var(--pending-color)!important}.fc-list-event.status-urgent .fc-list-event-dot{border-color:var(--urgent-color)!important}.fc-list-event.status-completed .fc-list-event-dot{border-color:var(--completed-color)!important}.fc-list-event-time{color:var(--font-color)!important;opacity:.8}.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,.7);align-items:center;justify-content:center}.modal-content{background-color:var(--primary-color);padding:30px;border-radius:15px;width:90%;max-width:600px;position:relative;box-shadow:0 5px 25px rgba(0,0,0,.5);max-height:80vh;display:flex;flex-direction:column}.close-btn{position:absolute;top:15px;right:20px;color:#aaa;font-size:28px;font-weight:700;cursor:pointer}#taskForm input[type="text"],#taskForm textarea{width:calc(100% - 24px);padding:12px;margin-bottom:15px;border-radius:8px;border:1px solid var(--secondary-color);background-color:var(--bg-color);color:var(--font-color);font-size:1em}#taskForm textarea{font-family:'Poppins',sans-serif;resize:vertical}#taskForm button{width:100%;padding:15px;border:none;border-radius:8px;background-color:var(--accent-color);color:#fff;font-size:1.1em;cursor:pointer}
        
        /* --- NUEVOS ESTILOS DRAG & DROP --- */
        .file-drop-zone { border: 2px dashed var(--secondary-color); border-radius: 8px; padding: 15px; text-align: center; cursor: pointer; transition: background-color 0.2s ease, border-color 0.2s ease; margin-bottom: 5px; font-size: 0.9em; color: var(--font-color); opacity: 0.8; }
        .file-drop-zone.drag-over { background-color: var(--secondary-color); border-color: var(--accent-color); opacity: 1; }
        .file-drop-zone input[type="file"] { display: none; }
        #current-attachment-envio, #current-attachment-cierre { margin-top: -10px; margin-bottom: 15px; }
        /* --- FIN NUEVOS ESTILOS --- */
        
        #taskDetailContent{line-height:1.7;overflow-y:auto;word-wrap:break-word;padding-right:15px}#taskDetailContent h3{margin-top:0;color:var(--accent-color)}#taskDetailContent p{margin:10px 0;background-color:var(--card-bg);padding:10px;border-radius:8px}#taskDetailContent p a{color:var(--accent-color);text-decoration:none;font-weight:700}#taskDetailContent p a:hover{text-decoration:underline}#taskDetailActions{display:flex;gap:10px;margin-top:20px;flex-shrink:0}#taskDetailActions button{flex-grow:1;padding:12px;border-radius:8px;border:none;color:#fff;font-size:1em;cursor:pointer;transition:opacity .3s}#editTaskBtn{background-color:#3498db}#completeTaskBtn{background-color:#95a5a6}#deleteTaskBtn{background-color:var(--urgent-color)}
        #alertModal .modal-content { max-width: 500px; } #alertModal h2 { color: var(--urgent-color); } #alertList { list-style: none; padding: 0; margin-top: 15px; } #alertList li { background-color: var(--card-bg); padding: 8px 12px; border-radius: 5px; margin-bottom: 8px; font-size: 0.9em; } #alertList li strong { color: var(--accent-color); }
    </style>
</head>
<body>
    <div class="container">
        <header><h1>Control de Tareas - SAP Ariba</h1></header>
        <div id="calendar-container"><div id="calendar"></div></div>
    </div>
    <script type="module">
    // Importar funciones de los SDKs de Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // Tu configuración personal de Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDoLccZFrBLBBAtYJpYx_hHhGEzX_el--k",
        authDomain: "control-de-tareas-ariba.firebaseapp.com",
        projectId: "control-de-tareas-ariba",
        storageBucket: "control-de-tareas-ariba.firebasestorage.app",
        messagingSenderId: "411622680191",
        appId: "1:411622680191:web:42c2243154a0429a3ac14a",
        measurementId: "G-YQPCKEYHYH"
    };

    // Inicializar Firebase y servicios
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const tasksCollection = collection(db, "tasks");

    // --- LÓGICA DE LA APLICACIÓN ---
    document.addEventListener('DOMContentLoaded', () => {
        const calendarEl = document.getElementById('calendar');
        let currentTaskId = null;
        let calendar;
        let allTasks = []; 
        let statusChart = null; 
        let firstLoad = true;

        // --- FUNCIONES AUXILIARES ---
        const getTaskStatus = (task) => {
            if (task.completed) return 'completed';
            const now = new Date(); now.setHours(0,0,0,0);
            const due = new Date(task.dueDate + 'T00:00:00');
            const diffDays = (due - now) / (1000*60*60*24);
            return diffDays < 2 ? 'urgent' : 'pending';
        };

        function createModal(id,content){
            let modal=document.getElementById(id);
            if(modal)modal.remove(); 
            modal=document.createElement('div');
            modal.id=id;
            modal.className='modal';
            modal.innerHTML=`<div class="modal-content"><span class="close-btn">&times;</span>${content}</div>`;
            document.body.appendChild(modal);
            modal.querySelector('.close-btn').onclick=()=>modal.style.display='none';
            return modal;
        }
        
        // --- HTML DE MODALES ACTUALIZADO ---
        const taskFormModalHTML=`
            <h2 id="modal-title"></h2>
            <form id="taskForm">
                <input type="hidden" id="taskId">
                <input type="text" id="taskName" placeholder="Título de la Tarea" required>
                <input type="text" id="taskClient" placeholder="Cliente" required>
                <textarea id="aribaComm" placeholder="Comunicación Ariba..." rows="4" required></textarea>
                
                <label for="taskAttachmentEnvio" class="file-drop-zone" id="drop-zone-envio">
                    <span id="drop-text-envio">Arrastra un archivo aquí o haz clic (Envío)</span>
                    <input type="file" id="taskAttachmentEnvio">
                </label>
                <div id="current-attachment-envio" style="font-size: 0.8em; opacity: 0.8;"></div>

                <label for="taskAttachmentCierre" class="file-drop-zone" id="drop-zone-cierre">
                    <span id="drop-text-cierre">Arrastra un archivo aquí o haz clic (Cierre)</span>
                    <input type="file" id="taskAttachmentCierre">
                </label>
                <div id="current-attachment-cierre" style="font-size: 0.8em; opacity: 0.8;"></div>
                
                <input type="hidden" id="dueDate">
                <button type="submit">Guardar Tarea</button>
            </form>`;
        const taskDetailModalHTML=`<div id="taskDetailContent"></div><div id="taskDetailActions"><button id="completeTaskBtn"></button><button id="editTaskBtn">Editar</button><button id="deleteTaskBtn">Eliminar</button></div>`;
        
        const taskFormModal=createModal('taskModal',taskFormModalHTML);
        const taskDetailModal=createModal('taskDetailModal',taskDetailModalHTML);
        const taskForm = document.getElementById('taskForm'); 

        // --- LÓGICA DE DRAG & DROP ---
        function setupDropZone(dropZoneId, inputId, textId) {
            const dropZone = taskFormModal.querySelector(dropZoneId);
            const fileInput = document.getElementById(inputId);
            const dropText = taskFormModal.querySelector(textId);
            
            const preventDefaults = (e) => { e.preventDefault(); e.stopPropagation(); };
            const highlight = () => dropZone.classList.add('drag-over');
            const unhighlight = () => dropZone.classList.remove('drag-over');

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, highlight, false);
            });
            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, unhighlight, false);
            });
            
            dropZone.addEventListener('drop', (e) => {
                fileInput.files = e.dataTransfer.files;
                dropText.textContent = `Archivo: ${e.dataTransfer.files[0].name}`;
            }, false);
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    dropText.textContent = `Archivo: ${e.target.files[0].name}`;
                }
            });
        }
        setupDropZone('#drop-zone-envio', 'taskAttachmentEnvio', '#drop-text-envio');
        setupDropZone('#drop-zone-cierre', 'taskAttachmentCierre', '#drop-text-cierre');
        // --- FIN LÓGICA DRAG & DROP ---

        function closeAllModals() { 
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => modal.style.display = 'none');
        }
        window.onclick = (e) => { if (e.target.classList.contains('modal')) closeAllModals(); };
        
        // --- FUNCIÓN PARA EXPORTAR A EXCEL (ACTUALIZADA) ---
        function exportToExcel(){
            if(allTasks.length === 0)return void alert("No hay tareas para exportar.");
            const e=allTasks.map((e=>{let t="";const a=getTaskStatus(e);return"completed"===a?t="Completada":"urgent"===a?t="Urgente":t="Pendiente",{"ID Tarea":e.id,Título:e.name,Cliente:e.client,"Comunicación Ariba":e.aribaComm,"Fecha de Vencimiento":e.dueDate,Estado:t, 'Adjunto Envío':e.attachmentEnvioName||"No", 'Adjunto Cierre':e.attachmentCierreName||"No"}})),t=XLSX.utils.json_to_sheet(e),a=XLSX.utils.book_new();XLSX.utils.book_append_sheet(a,t,"Tareas"),t["!cols"]=[{wch:20},{wch:40},{wch:20},{wch:60},{wch:20},{wch:15},{wch:30},{wch:30}],XLSX.writeFile(a,"ReporteDeTareas.xlsx")
        }
        
        // --- LÓGICA PARA EL GRÁFICO ---
        function openDashboard(){
            const e={completed:0,urgent:0,pending:0};allTasks.forEach((t=>{const a=getTaskStatus(t);e[a]++}));const t=createModal("dashboardModal",`\n                <h2 style="color: var(--accent-color);">Dashboard de Tareas</h2>\n                <div style="width: 80%; max-width: 400px; margin: 20px auto;">\n                    <canvas id="statusChart"></canvas>\n                </div>\n            `);t.style.display="flex";const a=document.getElementById("statusChart").getContext("2d");statusChart&&statusChart.destroy(),statusChart=new Chart(a,{type:"pie",data:{labels:[`Completadas (${e.completed})`,`Urgentes (${e.urgent})`,`Pendientes (${e.pending})`],datasets:[{label:"Tareas por Estado",data:[e.completed,e.urgent,e.pending],backgroundColor:["#2ecc71","#e74c3c","#f1c40f"],hoverOffset:4}]},options:{responsive:!0,plugins:{legend:{position:"top",labels:{color:"white"}}}}})
        }
        
        // --- FUNCIÓN PARA MOSTRAR ALERTAS ---
        function showUrgentTasksAlert(urgentTasks) {
            const alertModal = createModal('alertModal', `
                <h2><span style="font-size: 1.5em;">⚠️</span> ¡Tareas Urgentes!</h2>
                <p>Las siguientes tareas requieren atención inmediata:</p>
                <ul id="alertList"></ul>
            `);
            const alertList = alertModal.querySelector('#alertList');
            urgentTasks.forEach(task => {
                const li = document.createElement('li');
                const dueDate = new Date(task.dueDate + 'T00:00:00').toLocaleDateString("es-ES", {day:'numeric', month:'short'});
                li.innerHTML = `${task.name} - <strong>Vence: ${dueDate}</strong>`;
                alertList.appendChild(li);
            });
            alertModal.style.display = 'flex';
        }
        
        // --- CALENDARIO ---
        calendar = new FullCalendar.Calendar(calendarEl, {
            locale: 'es',
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listMonth'
            },
            footerToolbar: {
                right: 'dashboardButton exportButton' 
            },
            customButtons: {
                exportButton: { text: 'Exportar a Excel', click: exportToExcel },
                dashboardButton: { text: 'Dashboard', click: openDashboard }
            },
            height: 'auto', 
            dateClick: (info) => openFormModal({ date: info.dateStr }),
            eventClick: (info) => {
                currentTaskId = info.event.id;
                openDetailModal(info.event.extendedProps);
            }
        });
        calendar.render();

        // --- LECTURA EN TIEMPO REAL ---
        onSnapshot(tasksCollection, (querySnapshot) => {
            const tasks = [];
            querySnapshot.forEach((doc) => {
                tasks.push({ id: doc.id, ...doc.data() });
            });
            allTasks = tasks; 
            
            calendar.removeAllEvents();
            calendar.addEventSource(tasks.map(task => ({
                id: task.id, 
                title: `${task.client ? task.client + ': ' : ''}${task.name}`, 
                start: task.dueDate,
                classNames: [`status-${getTaskStatus(task)}`],
                extendedProps: task
            })));
            
            if (firstLoad) {
                const urgentTasks = allTasks.filter(task => getTaskStatus(task) === 'urgent');
                if (urgentTasks.length > 0) {
                    showUrgentTasksAlert(urgentTasks);
                }
                firstLoad = false;
                 setTimeout(() => { calendar.updateSize(); }, 200);
            }
        });

        // --- FUNCIONES CRUD ACTUALIZADAS ---
        async function saveTask(taskData){
            const{id:e, fileEnvio:t, fileCierre:a, ...data}=taskData;
            const o=taskFormModal.querySelector('button[type="submit"]');
            o.disabled=!0;
            o.textContent="Guardando...";
            try{
                if(t){
                    const e=`attachments/${Date.now()}_envio_${t.name}`;
                    const fileRef=ref(storage,e); 
                    await uploadBytes(fileRef,t); 
                    data.attachmentEnvioUrl=await getDownloadURL(fileRef); 
                    data.attachmentEnvioName=t.name;
                }
                if(a){
                    const e=`attachments/${Date.now()}_cierre_${a.name}`;
                    const fileRef=ref(storage,e); 
                    await uploadBytes(fileRef,a); 
                    data.attachmentCierreUrl=await getDownloadURL(fileRef); 
                    data.attachmentCierreName=a.name;
                }
                
                if(e){ 
                    const docRef = doc(db,"tasks",e); 
                    await updateDoc(docRef,data); 
                } else { 
                    await addDoc(tasksCollection,data);
                }
                closeAllModals()
            }catch(r){
                console.error("Error al guardar la tarea: ",r);
                alert("Hubo un error al guardar la tarea.");
            }finally{
                o.disabled=!1;
                o.textContent="Guardar Tarea";
            }
        }

        async function deleteTask(){
            if(!currentTaskId)return;
            if(confirm('¿Estás seguro de que quieres eliminar esta tarea?')){
                const docRef=doc(db,"tasks",currentTaskId); 
                const t=await getDoc(docRef); 
                const a=t.data();
                
                if(a.attachmentEnvioUrl)try{
                    const fileRef=ref(storage,a.attachmentEnvioUrl); 
                    await deleteObject(fileRef) 
                }catch(o){console.warn("Adjunto de envío no se pudo eliminar:",o.message)}
                
                if(a.attachmentCierreUrl)try{
                    const fileRef=ref(storage,a.attachmentCierreUrl); 
                    await deleteObject(fileRef) 
                }catch(o){console.warn("Adjunto de cierre no se pudo eliminar:",o.message)}

                await deleteDoc(docRef),closeAllModals() 
            }
        }

        async function toggleComplete(){
            if(!currentTaskId)return;
            const docRef=doc(db,"tasks",currentTaskId); 
            const t=await getDoc(docRef); 
            const a=t.data().completed,o={completed:!a,completionDate:a?null:(new Date).toISOString().split("T")[0]};
            await updateDoc(docRef,o),closeAllModals() 
        }
        
        // --- FUNCIONES DE MODALES ACTUALIZADAS ---
        function openFormModal({task:e,date:t}){
            closeAllModals();
            taskForm.reset();

            // Resetea el texto de las zonas de drop
            taskFormModal.querySelector('#drop-text-envio').textContent = 'Arrastra un archivo aquí o haz clic (Envío)';
            taskFormModal.querySelector('#drop-text-cierre').textContent = 'Arrastra un archivo aquí o haz clic (Cierre)';

            const a=taskFormModal.querySelector("#modal-title"),o=taskFormModal.querySelector("#taskId"),r=taskFormModal.querySelector("#dueDate");
            const nEnvio=taskFormModal.querySelector("#current-attachment-envio");
            const nCierre=taskFormModal.querySelector("#current-attachment-cierre");
            nEnvio.textContent="";
            nCierre.textContent="";

            if(e){ 
                a.textContent="Editar Tarea";
                o.value=e.id;
                document.getElementById("taskName").value=e.name;
                document.getElementById("taskClient").value=e.client;
                document.getElementById("aribaComm").value=e.aribaComm;
                r.value=e.dueDate;
                if(e.attachmentEnvioName) nEnvio.textContent=`Envío actual: ${e.attachmentEnvioName}`
                if(e.attachmentCierreName) nCierre.textContent=`Cierre actual: ${e.attachmentCierreName}`
            } else { 
                a.textContent="Nueva Tarea";
                o.value="";
                r.value=t;
            }
            taskFormModal.style.display="flex";
        }
        
        function openDetailModal(e){
            closeAllModals();
            const t=taskDetailModal.querySelector("#taskDetailContent"),a=new Date(e.dueDate+"T00:00:00").toLocaleDateString("es-ES",{year:"numeric",month:"long",day:"numeric",timeZone:"UTC"});
            
            let o="";
            if(e.attachmentEnvioUrl&&e.attachmentEnvioName)o+=`<p><strong>Adjunto Envío:</strong> <a href="${e.attachmentEnvioUrl}" target="_blank" rel="noopener noreferrer">${e.attachmentEnvioName}</a></p>`;
            if(e.attachmentCierreUrl&&e.attachmentCierreName)o+=`<p><strong>Adjunto Cierre:</strong> <a href="${e.attachmentCierreUrl}" target="_blank" rel="noopener noreferrer">${e.attachmentCierreName}</a></p>`;
            
            t.innerHTML=`<h3>${e.name}</h3><p><strong>Cliente:</strong> ${e.client}</p><p><strong>Comunicación Ariba:</strong><br>${e.aribaComm.replace(/\n/g,"<br>")}</p>${o}<p><strong>Vencimiento:</strong> ${a}</p>`;
            
            const r=taskDetailModal.querySelector("#completeTaskBtn");
            r.textContent=e.completed?"Marcar como Pendiente":"Completar Tarea";
            r.style.backgroundColor=e.completed?"var(--pending-color)":"var(--completed-color)";
            taskDetailModal.style.display="flex";
        }

        // --- EVENT LISTENER ACTUALIZADO ---
        taskForm.addEventListener("submit",e=>{
            e.preventDefault();
            const tEnvio = document.getElementById("taskAttachmentEnvio");
            const tCierre = document.getElementById("taskAttachmentCierre");
            
            const a={
                id:document.getElementById("taskId").value,
                name:document.getElementById("taskName").value,
                client:document.getElementById("taskClient").value,
                aribaComm:document.getElementById("aribaComm").value,
                dueDate:document.getElementById("dueDate").value,
                fileEnvio: tEnvio.files[0] || null, 
                fileCierre: tCierre.files[0] || null 
            };
            if(!a.id)a.completed=!1;
            saveTask(a);
        });
        
        taskDetailModal.querySelector("#editTaskBtn").onclick=async()=>{
            const e=doc(db,"tasks",currentTaskId),t=await getDoc(e);
            if(t.exists())openFormModal({task:{id:t.id,...t.data()}})
        };
        
        taskDetailModal.querySelector("#deleteTaskBtn").onclick=deleteTask;
        taskDetailModal.querySelector("#completeTaskBtn").onclick=toggleComplete;

    });
</script>
</body>
</html>
